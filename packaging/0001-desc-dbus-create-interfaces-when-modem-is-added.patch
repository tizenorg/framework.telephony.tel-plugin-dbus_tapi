From ec42dbbe5a71887c55766891f9c340d824a07659 Mon Sep 17 00:00:00 2001
From: Caiwen Zhang <caiwen.zhang@intel.com>
Date: Thu, 27 Dec 2012 22:07:29 +0800
Subject: [PATCH 1/2] desc-dbus: create interfaces when modem is added
Content-Type: text/plain; charset="utf-8"
Content-Transfer-Encoding: 8bit

Merge "Change Ic4376ea2: desc-dbus: Create interfaces when modem
is added", Oct 16, submitted by Guillaume on master branch.
---
 src/desc-dbus.c |   51 ++++++---------------------------------------------
 1 file changed, 6 insertions(+), 45 deletions(-)

diff --git a/src/desc-dbus.c b/src/desc-dbus.c
index a2a135f..42e4b0f 100644
--- a/src/desc-dbus.c
+++ b/src/desc-dbus.c
@@ -135,43 +135,6 @@ OUT:
 		g_free(path);
 }
 
-static void refresh_object(struct custom_data *ctx)
-{
-	GSList *plugins;
-	GSList *cur;
-	GSList *co_list;
-	TcorePlugin *p;
-
-	if (!ctx->manager) {
-		dbg("not ready..");
-		return;
-	}
-
-	plugins = tcore_server_ref_plugins(ctx->server);
-	if (!plugins)
-		return;
-
-	cur = plugins;
-	for (cur = plugins; cur; cur = cur->next) {
-		p = cur->data;
-		if (!p)
-			continue;
-
-		co_list = tcore_plugin_get_core_objects_bytype(p, CORE_OBJECT_TYPE_MODEM);
-		if (!co_list)
-			continue;
-
-		if (!tcore_object_get_hal(co_list->data)) {
-			g_slist_free(co_list);
-			continue;
-		}
-
-		g_slist_free(co_list);
-
-		add_modem(ctx, p);
-	}
-}
-
 static TReturn send_response(Communicator *comm, UserRequest *ur, enum tcore_response_command command, unsigned int data_len, const void *data)
 {
 	struct custom_data *ctx = NULL;
@@ -247,6 +210,7 @@ static TReturn send_notification(Communicator *comm, CoreObject *source, enum tc
 	char *plugin_name;
 	char *path;
 	TelephonyObjectSkeleton *object;
+	TcorePlugin *p = tcore_object_ref_plugin(source);
 
 	dbg("notification !!! (command = 0x%x, data_len = %d)", command, data_len);
 
@@ -256,7 +220,7 @@ static TReturn send_notification(Communicator *comm, CoreObject *source, enum tc
 		return FALSE;
 	}
 
-	plugin_name = tcore_plugin_ref_plugin_name(tcore_object_ref_plugin(source));
+	plugin_name = tcore_plugin_ref_plugin_name(p);
 	if (plugin_name) {
 		path = g_strdup_printf("%s/%s", MY_DBUS_PATH, plugin_name);
 	}
@@ -293,7 +257,10 @@ static TReturn send_notification(Communicator *comm, CoreObject *source, enum tc
 			break;
 
 		case TNOTI_MODEM:
-			dbus_plugin_modem_notification(ctx, plugin_name, object, command, data_len, data);
+			if (command == TNOTI_MODEM_ADDED)
+				add_modem(ctx, p);
+			else
+				dbus_plugin_modem_notification(ctx, plugin_name, object, command, data_len, data);
 			break;
 
 		case TNOTI_SMS:
@@ -315,9 +282,6 @@ static TReturn send_notification(Communicator *comm, CoreObject *source, enum tc
 			break;
 
 		case TNOTI_SERVER:
-			if (command == TNOTI_SERVER_RUN) {
-				refresh_object(ctx);
-			}
 			break;
 
 		default:
@@ -394,8 +358,6 @@ static void on_bus_acquired(GDBusConnection *conn, const gchar *name, gpointer u
 
 	info("dbus registered");
 
-	refresh_object(ctx);
-
 	/* Add interface to default object path */
 	mgr = telephony_manager_skeleton_new();
 	g_signal_connect (mgr,
@@ -468,7 +430,6 @@ static gboolean on_init(TcorePlugin *p)
 			NULL);
 
 	data->manager = g_dbus_object_manager_server_new (MY_DBUS_PATH);
-	refresh_object(data);
 
 	return TRUE;
 }
-- 
1.7.10.4

